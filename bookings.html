<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Booking System</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #ffedd5 0%, #fef3c7 100%);
        }
        .booking-card {
            backdrop-filter: blur(10px);
            background-color: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
        }
        .cta-button {
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 115, 255, 0.3);
        }
        .cta-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 115, 255, 0.4);
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="booking-card rounded-2xl w-full max-w-2xl p-6 md:p-10 space-y-8">
        <!-- Header Section -->
        <header class="text-center space-y-2">
            <h1 class="text-4xl font-extrabold text-stone-800 tracking-tight">Book an Appointment</h1>
            <p class="text-lg text-gray-600">
                Easily manage your bookings with real-time updates.
            </p>
            <div id="auth-status" class="text-sm text-gray-400 mt-2">Authenticating...</div>
        </header>

        <!-- Booking Form -->
        <form id="booking-form" class="space-y-6">
            <div class="space-y-4">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700">Full Name</label>
                    <input type="text" id="name" name="name" required
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-xl shadow-sm focus:ring-teal-500 focus:border-teal-500 transition duration-150">
                </div>
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700">Email Address</label>
                    <input type="email" id="email" name="email" required
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-xl shadow-sm focus:ring-teal-500 focus:border-teal-500 transition duration-150">
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="date" class="block text-sm font-medium text-gray-700">Date</label>
                        <input type="date" id="date" name="date" required
                               class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-xl shadow-sm focus:ring-teal-500 focus:border-teal-500 transition duration-150">
                    </div>
                    <div>
                        <label for="time" class="block text-sm font-medium text-gray-700">Time</label>
                        <input type="time" id="time" name="time" required
                               class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-xl shadow-sm focus:ring-teal-500 focus:border-teal-500 transition duration-150">
                    </div>
                </div>
            </div>

            <button type="submit"
                    class="w-full py-3 px-4 bg-teal-600 hover:bg-teal-700 text-white font-bold rounded-xl cta-button">
                Submit Booking
            </button>
        </form>

        <div id="message-box" class="hidden p-4 rounded-xl text-center font-medium transition duration-300"></div>

        <!-- Button to add sample bookings -->
        <div class="text-center mt-4">
            <button id="add-samples-btn"
                    class="py-2 px-6 bg-green-700 hover:bg-green-800 text-white font-bold rounded-full shadow-md transition duration-200">
                Add Sample Bookings
            </button>
        </div>
        
        <!-- Bookings Display Section -->
        <section>
            <h2 class="text-2xl font-bold text-stone-800 mb-4 tracking-tight">Upcoming Bookings</h2>
            <div id="booking-list" class="space-y-4">
                <!-- Bookings will be rendered here dynamically -->
                <div id="loading-spinner" class="text-center text-gray-500">Loading bookings...</div>
            </div>
        </section>

        <!-- Reminder Modal -->
        <div id="reminder-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl shadow-xl p-6 w-full max-w-md">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">Drafted Reminder</h3>
                    <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div id="reminder-text" class="text-gray-700 text-lg leading-relaxed mb-4"></div>
                <button id="copy-btn" class="w-full py-2 px-4 bg-green-500 hover:bg-green-600 text-white font-semibold rounded-lg transition duration-200">
                    Copy to Clipboard
                </button>
            </div>
        </div>

    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, deleteDoc, onSnapshot, query, setLogLevel, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Configuration (provided by the environment)
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Set log level for Firebase (helpful for debugging)
        setLogLevel('debug');

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const bookingForm = document.getElementById('booking-form');
        const bookingList = document.getElementById('booking-list');
        const messageBox = document.getElementById('message-box');
        const authStatusEl = document.getElementById('auth-status');
        const loadingSpinner = document.getElementById('loading-spinner');
        const addSamplesBtn = document.getElementById('add-samples-btn');
        const reminderModal = document.getElementById('reminder-modal');
        const reminderTextEl = document.getElementById('reminder-text');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const copyBtn = document.getElementById('copy-btn');

        let userId = null;
        let isAuthReady = false;

        // Display a message to the user
        const showMessage = (message, type) => {
            messageBox.textContent = message;
            messageBox.className = `p-4 rounded-xl text-center font-medium transition duration-300 transform scale-100 ${type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'} mt-4`;
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 3000);
        };

        // --- Firebase Authentication ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                isAuthReady = true;
                authStatusEl.textContent = `Authenticated. User ID: ${userId}`;
                console.log("Firebase Auth State Changed: User is authenticated. UID:", userId);
                // Start listening for bookings after authentication
                listenForBookings();
            } else {
                userId = null;
                isAuthReady = false;
                authStatusEl.textContent = 'Signing in...';
                console.log("Firebase Auth State Changed: User is not authenticated. Attempting to sign in.");
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Authentication Error:", error);
                    authStatusEl.textContent = `Authentication failed. Check the console for details.`;
                    showMessage('Authentication failed. Please try again later.', 'error');
                }
            }
        });

        // --- Firestore Data Operations ---
        const getBookingsCollection = (uid) => {
            return collection(db, `artifacts/${appId}/users/${uid}/bookings`);
        };

        // Real-time listener for bookings
        const listenForBookings = () => {
            if (!isAuthReady || !userId) {
                console.warn("Attempted to listen for bookings before authentication was ready.");
                return;
            }

            const bookingsCollection = getBookingsCollection(userId);
            const q = query(bookingsCollection);

            onSnapshot(q, (querySnapshot) => {
                loadingSpinner.style.display = 'none'; // Hide spinner once data is received
                const bookings = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    bookings.push({
                        id: doc.id,
                        ...data,
                        // Convert Firestore timestamp to JS Date for sorting
                        timestamp: data.timestamp ? data.timestamp.toDate() : new Date(0)
                    });
                });
                
                if (bookings.length === 0) {
                    bookingList.innerHTML = `<p class="text-center text-gray-500 italic">No bookings yet. Add one above!</p>`;
                }

                // Sort bookings by date and time
                bookings.sort((a, b) => {
                    if (a.date === b.date) {
                        return a.time.localeCompare(b.time);
                    }
                    return a.date.localeCompare(b.date);
                });

                renderBookings(bookings);
            }, (error) => {
                console.error("Error fetching bookings:", error);
                showMessage('Error loading bookings. Check the console for details.', 'error');
            });
        };

        const addBooking = async (bookingData) => {
            if (!isAuthReady || !userId) {
                showMessage('Authentication not ready. Please wait.', 'error');
                return;
            }
            try {
                const bookingsCollection = getBookingsCollection(userId);
                await addDoc(bookingsCollection, {
                    ...bookingData,
                    status: 'Confirmed', // New: Add a status field
                    timestamp: new Date()
                });
                showMessage('Booking successfully added!', 'success');
            } catch (e) {
                console.error("Error adding document: ", e);
                showMessage('Error adding booking. Please try again.', 'error');
            }
        };

        const deleteBooking = async (id) => {
            if (!isAuthReady || !userId) {
                showMessage('Authentication not ready. Please wait.', 'error');
                return;
            }
            try {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/bookings`, id);
                await deleteDoc(docRef);
                showMessage('Booking successfully deleted!', 'success');
            } catch (e) {
                console.error("Error deleting document: ", e);
                showMessage('Error deleting booking. Please try again.', 'error');
            }
        };

        // New: Function to update a booking's status
        const updateBookingStatus = async (id, newStatus) => {
            if (!isAuthReady || !userId) {
                showMessage('Authentication not ready. Please wait.', 'error');
                return;
            }
            try {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/bookings`, id);
                await updateDoc(docRef, {
                    status: newStatus
                });
                showMessage(`Booking marked as ${newStatus}!`, 'success');
            } catch (e) {
                console.error("Error updating booking status:", e);
                showMessage('Error updating booking status. Please try again.', 'error');
            }
        };

        // --- Function to add sample bookings ---
        const addSampleBookings = async () => {
            if (!isAuthReady || !userId) {
                showMessage('Authentication not ready. Please wait.', 'error');
                return;
            }

            const sampleBookings = [
                { name: 'Alice Smith', email: 'alice.s@example.com', date: '2025-10-20', time: '10:00', status: 'Confirmed' },
                { name: 'Bob Johnson', email: 'b.johnson@example.com', date: '2025-10-21', time: '14:30', status: 'Confirmed' },
                { name: 'Charlie Brown', email: 'c.brown@example.com', date: '2025-10-22', time: '09:00', status: 'Confirmed' },
            ];

            try {
                const bookingsCollection = getBookingsCollection(userId);
                for (const booking of sampleBookings) {
                    await addDoc(bookingsCollection, {
                        ...booking,
                        timestamp: new Date()
                    });
                }
                showMessage('Sample bookings added successfully!', 'success');
            } catch (e) {
                console.error("Error adding sample bookings: ", e);
                showMessage('Failed to add sample bookings. Please try again.', 'error');
            }
        };
        
        // --- Gemini API Function to draft a reminder ---
        const draftReminder = async (booking) => {
            const prompt = `Draft a professional and friendly reminder message for a booking. The booking details are:
            Name: ${booking.name}
            Email: ${booking.email}
            Date: ${booking.date}
            Time: ${booking.time}
            
            The reminder should be concise and include a clear call to action. Do not include placeholders or any other content besides the reminder text itself.`;
            
            // Set up the API call
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
            };

            let retries = 0;
            const maxRetries = 3;

            while (retries < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const generatedText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                        return generatedText || "Could not draft reminder. Please try again.";
                    } else if (response.status === 429) { // Too many requests
                        const delay = Math.pow(2, retries) * 1000;
                        await new Promise(res => setTimeout(res, delay));
                        retries++;
                    } else {
                        throw new Error(`API call failed with status: ${response.status}`);
                    }
                } catch (error) {
                    console.error("Error calling Gemini API:", error);
                    retries++;
                }
            }
            return "Failed to draft reminder after multiple attempts. Please try again.";
        };

        // --- UI Rendering ---
        const renderBookings = (bookings) => {
            bookingList.innerHTML = '';
            if (bookings.length === 0) {
                bookingList.innerHTML = `<p class="text-center text-gray-500 italic">No bookings yet. Add one above!</p>`;
                return;
            }

            bookings.forEach(booking => {
                const bookingEl = document.createElement('div');
                bookingEl.className = "bg-white p-4 rounded-xl border border-gray-100 shadow-md flex flex-col sm:flex-row justify-between items-start sm:items-center";
                
                // Determine status color and text
                const statusColor = booking.status === 'Confirmed' ? 'bg-emerald-500' : 'bg-stone-500';
                const statusText = booking.status === 'Confirmed' ? 'Confirmed' : 'Completed';
                
                const bookingContent = `
                    <div class="flex-grow space-y-1 mb-2 sm:mb-0">
                        <p class="text-lg font-semibold text-gray-800">${booking.name}</p>
                        <p class="text-sm text-gray-600">${booking.email}</p>
                        <p class="text-sm text-gray-500">${booking.date} at ${booking.time}</p>
                        <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium text-white ${statusColor}">
                            ${statusText}
                        </span>
                    </div>
                    <div class="flex space-x-2">
                        <button data-id="${booking.id}" data-name="${booking.name}" data-date="${booking.date}" data-time="${booking.time}" class="draft-btn bg-orange-500 hover:bg-orange-600 text-white font-bold py-1 px-3 rounded-lg text-sm transition duration-200">
                            ✨ Draft Reminder
                        </button>
                        ${booking.status === 'Confirmed' ? `<button data-id="${booking.id}" class="complete-btn bg-sky-500 hover:bg-sky-600 text-white font-bold py-1 px-3 rounded-lg text-sm transition duration-200">
                            ✓ Mark as Completed
                        </button>` : ''}
                        <button data-id="${booking.id}" class="delete-btn bg-rose-500 hover:bg-rose-600 text-white font-bold py-1 px-3 rounded-lg text-sm transition duration-200">
                            Delete
                        </button>
                    </div>
                `;
                bookingEl.innerHTML = bookingContent;
                bookingList.appendChild(bookingEl);
            });
        };

        // --- Event Listeners ---
        bookingForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const formData = new FormData(bookingForm);
            const bookingData = {
                name: formData.get('name'),
                email: formData.get('email'),
                date: formData.get('date'),
                time: formData.get('time')
            };

            addBooking(bookingData);
            bookingForm.reset();
        });

        bookingList.addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-btn')) {
                const bookingId = e.target.getAttribute('data-id');
                deleteBooking(bookingId);
            }

            if (e.target.classList.contains('draft-btn')) {
                const btn = e.target;
                const originalText = btn.textContent;
                btn.textContent = 'Drafting...';
                btn.disabled = true;

                const booking = {
                    name: btn.getAttribute('data-name'),
                    date: btn.getAttribute('data-date'),
                    time: btn.getAttribute('data-time'),
                };

                const reminder = await draftReminder(booking);
                reminderTextEl.textContent = reminder;
                reminderModal.style.display = 'flex';

                btn.textContent = originalText;
                btn.disabled = false;
            }

            if (e.target.classList.contains('complete-btn')) {
                const bookingId = e.target.getAttribute('data-id');
                await updateBookingStatus(bookingId, 'Completed');
            }
        });

        closeModalBtn.addEventListener('click', () => {
            reminderModal.style.display = 'none';
        });

        // Copy reminder text to clipboard
        copyBtn.addEventListener('click', () => {
            const textToCopy = reminderTextEl.textContent;
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = textToCopy;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            document.execCommand('copy');
            document.body.removeChild(tempTextArea);
            showMessage('Copied to clipboard!', 'success');
        });

        // Event listener for adding sample bookings
        addSamplesBtn.addEventListener('click', addSampleBookings);
        
    </script>

</body>
</html>
